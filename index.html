<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minah Teacher's English Class Points</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🌟</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyBdyW1w2iq79U44QDC0A_73PrcF4iWdZ9s",
            authDomain: "minah-teacher-s-class-points.firebaseapp.com",
            projectId: "minah-teacher-s-class-points",
            storageBucket: "minah-teacher-s-class-points.firebasestorage.app",
            messagingSenderId: "50388651847",
            appId: "1:50388651847:web:0607a021e7f3ed3c1b8662"
        };
        
        // Firebase 초기화
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        console.log('Firebase 초기화 완료');
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&display=swap');
        body { font-family: 'Nunito', sans-serif; }
        .cute-shadow { box-shadow: 0 4px 15px rgba(255, 182, 193, 0.3); }
        .point-card { transition: all 0.3s ease; }
        .point-card:hover { transform: translateY(-2px); }
        .menu-item { transition: all 0.3s ease; }
        .menu-item:hover { background-color: rgba(238, 242, 255, 0.8) !important; transform: translateX(4px); }
        .menu-item.active { background-color: rgba(224, 231, 255, 0.9) !important; }
        .login-container { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .floating-shapes {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        .shape {
            position: absolute;
            opacity: 0.1;
            animation: float 6s ease-in-out infinite;
        }
        .shape:nth-child(1) { top: 10%; left: 10%; animation-delay: 0s; }
        .shape:nth-child(2) { top: 20%; right: 10%; animation-delay: 2s; }
        .shape:nth-child(3) { bottom: 10%; left: 20%; animation-delay: 4s; }
        .shape:nth-child(4) { bottom: 20%; right: 20%; animation-delay: 1s; }
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }
    </style>
</head>
<body>
    <!-- 구글 로그인 화면 -->
    <div id="loginScreen" class="login-container flex items-center justify-center relative">
        <div class="floating-shapes">
            <div class="shape w-20 h-20 bg-white rounded-full"></div>
            <div class="shape w-16 h-16 bg-pink-300 rounded-full"></div>
            <div class="shape w-24 h-24 bg-yellow-300 rounded-full"></div>
            <div class="shape w-12 h-12 bg-blue-300 rounded-full"></div>
        </div>
        
        <div class="bg-white rounded-3xl cute-shadow p-8 max-w-md w-full mx-4 relative z-10">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">🌟</div>
                <h1 class="text-3xl font-bold text-purple-600 mb-2">Minah Teacher's</h1>
                <h2 class="text-xl text-gray-600">English Class Points</h2>
                <p class="text-sm text-gray-500 mt-2">구글 계정으로 로그인하세요</p>
            </div>
            
            <div class="space-y-4">
                <button id="googleLoginBtn" class="w-full bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white py-4 rounded-xl font-bold text-lg transition-all duration-300 transform hover:scale-105 shadow-lg flex items-center justify-center">
                    <svg class="w-6 h-6 mr-3" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    구글 계정으로 로그인
                </button>
                
                <div class="text-center">
                    <p class="text-xs text-gray-500">
                        🔒 안전한 구글 인증으로 보호됩니다
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- 교사 인증 화면 -->
    <div id="verificationScreen" class="login-container flex items-center justify-center relative hidden">
        <div class="bg-white rounded-3xl cute-shadow p-8 max-w-md w-full mx-4">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">🔐</div>
                <h2 class="text-2xl font-bold text-purple-600 mb-2">교사 인증</h2>
                <p id="userEmail" class="text-gray-600 mb-4"></p>
                <p class="text-sm text-gray-500">교사 인증 코드를 입력해주세요</p>
            </div>
            
            <div class="space-y-4">
                <input type="password" id="verificationCode" placeholder="인증 코드 입력" 
                       class="w-full px-4 py-3 border-2 border-purple-200 rounded-xl focus:border-purple-400 focus:outline-none text-center text-lg font-bold tracking-widest">
                <div class="flex space-x-3">
                    <button id="verifyBtn" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-semibold transition-colors">
                        ✅ 인증하기
                    </button>
                    <button id="cancelBtn" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 rounded-xl font-semibold transition-colors">
                        취소
                    </button>
                </div>
                <div class="text-center">
                    <p class="text-xs text-gray-500">
                        🔐 관리자로부터 받은 인증 코드를 입력하세요
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- 메인 앱 -->
    <div id="mainApp" class="hidden">
        <!-- 헤더 -->
        <div class="bg-white cute-shadow mb-8 sticky top-0 z-40">
            <div class="container mx-auto px-4 md:px-6 py-4">
                <div class="flex justify-between items-center">
                    <h1 class="text-lg md:text-4xl font-black text-indigo-700 ml-12 md:ml-0" style="font-family: 'Nunito', sans-serif; text-shadow: 2px 2px 4px rgba(0,0,0,0.1);">🌟 Minah Teacher's Class Points</h1>
                    <div class="flex items-center space-x-2 md:space-x-4">
                        <span id="userInfo" class="text-sm md:text-base text-purple-600 font-semibold"></span>
                        <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-3 md:px-6 py-2 rounded-full font-semibold transition-colors text-xs md:text-base">
                            🚪 로그아웃
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 모바일 메뉴 토글 -->
        <button id="mobileMenuToggle" class="md:hidden fixed top-4 left-4 z-50 bg-purple-500 text-white p-3 rounded-full shadow-lg">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>

        <div class="flex">
            <!-- 사이드바 -->
            <div id="sidebar" class="w-56 md:w-56 bg-gradient-to-b from-purple-100 via-indigo-100 to-violet-100 h-screen fixed left-0 top-0 pt-24 px-4 shadow-2xl transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-40">
                <div class="space-y-3">
                    <div class="text-sm md:text-lg font-bold text-indigo-700 mb-3 px-3">📅 학년도 선택</div>
                    <select id="yearSelect" class="w-full px-3 md:px-4 py-2 md:py-3 border-2 border-white rounded-xl focus:border-yellow-300 focus:outline-none text-xs md:text-sm mb-4 bg-white text-purple-700 font-semibold">
                        <option value="">학년도 선택</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                    </select>
                    
                    <div class="text-sm md:text-lg font-bold text-indigo-700 mb-3 px-3">📖 수업 선택</div>
                    <select id="subjectSelect" class="w-full px-3 md:px-4 py-2 md:py-3 border-2 border-white rounded-xl focus:border-yellow-300 focus:outline-none text-xs md:text-sm mb-4 bg-white text-purple-700 font-semibold">
                        <option value="">수업 선택</option>
                        <option value="영어">영어</option>
                    </select>
                    
                    <div class="text-sm md:text-lg font-bold text-indigo-700 mb-3 px-3">📚 반 선택</div>
                    <select id="classSelect" class="w-full px-3 md:px-4 py-2 md:py-3 border-2 border-white rounded-xl focus:border-yellow-300 focus:outline-none text-xs md:text-sm mb-5 bg-white text-purple-700 font-semibold">
                        <option value="">반을 선택하세요</option>
                        <option value="1반">1반</option>
                        <option value="2반">2반</option>
                        <option value="3반">3반</option>
                        <option value="4반">4반</option>
                        <option value="5반">5반</option>
                        <option value="6반">6반</option>
                        <option value="7반">7반</option>
                        <option value="8반">8반</option>
                        <option value="9반">9반</option>
                        <option value="10반">10반</option>
                    </select>
                    
                    <div class="border-t-2 border-gray-400 border-opacity-30 my-5"></div>
                    
                    <div class="text-sm md:text-lg font-bold text-indigo-700 mb-4 px-3">📋 메뉴</div>
                    <button id="menuPoints" class="menu-item w-full text-left px-3 md:px-4 py-2 md:py-3 rounded-xl font-bold text-indigo-700 bg-white bg-opacity-50 hover:bg-indigo-50 hover:bg-opacity-80 hover:shadow-lg transition-all duration-300 text-sm md:text-lg active">
                        ✨ 포인트 관리
                    </button>
                    <button id="menuStudents" class="menu-item w-full text-left px-3 md:px-4 py-2 md:py-3 rounded-xl font-bold text-indigo-700 bg-white bg-opacity-50 hover:bg-indigo-50 hover:bg-opacity-80 hover:shadow-lg transition-all duration-300 text-sm md:text-lg">
                        👥 학생 관리
                    </button>
                    <button id="menuRewards" class="menu-item w-full text-left px-3 md:px-4 py-2 md:py-3 rounded-xl font-bold text-indigo-700 bg-white bg-opacity-50 hover:bg-indigo-50 hover:bg-opacity-80 hover:shadow-lg transition-all duration-300 text-sm md:text-lg">
                        🎁 보상 관리
                    </button>
                    <button id="menuSettings" class="menu-item w-full text-left px-3 md:px-4 py-2 md:py-3 rounded-xl font-bold text-indigo-700 bg-white bg-opacity-50 hover:bg-indigo-50 hover:bg-opacity-80 hover:shadow-lg transition-all duration-300 text-sm md:text-lg">
                        ⚙️ 설정
                    </button>
                </div>
            </div>

            <!-- 오버레이 (모바일용) -->
            <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>

            <!-- 메인 콘텐츠 -->
            <div id="mainContent" class="flex-1 md:ml-56 px-4 md:px-8 pr-4 md:pr-12">
                <!-- 포인트 관리 -->
                <div id="pointsSection" class="space-y-8">
                    <div id="teacherControls" class="bg-white rounded-2xl cute-shadow p-6">
                        <h2 class="text-2xl font-bold text-purple-600 mb-4">✨ 포인트 관리</h2>
                        
                        <div class="grid md:grid-cols-2 gap-4 mb-4">
                            <select id="studentSelect" class="px-4 py-3 border-2 border-purple-200 rounded-xl focus:border-purple-400 focus:outline-none">
                                <option value="">학생 선택</option>
                            </select>
                            <input type="number" id="pointValue" placeholder="포인트" min="1" max="10"
                                   class="px-4 py-3 border-2 border-purple-200 rounded-xl focus:border-purple-400 focus:outline-none">
                        </div>

                        <div class="grid md:grid-cols-2 gap-4 mb-4">
                            <select id="pointCategory" class="px-4 py-3 border-2 border-purple-200 rounded-xl focus:border-purple-400 focus:outline-none">
                                <option value="">카테고리 선택</option>
                                <option value="발표">📢 발표</option>
                                <option value="과제">📝 과제</option>
                                <option value="참여">🙋‍♂️ 수업 참여</option>
                                <option value="협력">🤝 팀워크</option>
                                <option value="창의">💡 창의성</option>
                                <option value="기타">⭐ 기타</option>
                            </select>
                            <input type="text" id="pointDescription" placeholder="간단한 설명 (선택사항)" 
                                   class="px-4 py-3 border-2 border-purple-200 rounded-xl focus:border-purple-400 focus:outline-none">
                        </div>
                        
                        <button id="addPointBtn" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-semibold transition-colors">
                            🎉 포인트 추가
                        </button>
                    </div>

                    <!-- 학생 목록 -->
                    <div id="studentsDisplay" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
                </div>

                <!-- 학생 관리 -->
                <div id="studentsSection" class="space-y-8 hidden">
                    <!-- 엑셀 업로드 -->
                    <div class="bg-white rounded-2xl cute-shadow p-6">
                        <h2 class="text-2xl font-bold text-purple-600 mb-4">📊 학생 명단 업로드</h2>
                        <div class="mb-4">
                            <p class="text-sm text-gray-600 mb-2">엑셀 파일 형식: 연번(A열), 이름(B열)</p>
                            <input type="file" id="excelFile" accept=".xlsx,.xls" 
                                   class="w-full px-4 py-3 border-2 border-purple-200 rounded-xl focus:border-purple-400 focus:outline-none">
                        </div>
                        <button id="uploadBtn" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-semibold transition-colors">
                            📤 명단 업로드
                        </button>
                    </div>

                    <!-- 수동 학생 관리 -->
                    <div class="bg-white rounded-2xl cute-shadow p-6">
                        <h2 class="text-2xl font-bold text-purple-600 mb-4">👤 학생 개별 관리</h2>
                        <div class="grid md:grid-cols-3 gap-4 mb-4">
                            <input type="number" id="newStudentNumber" placeholder="번호" 
                                   class="px-4 py-3 border-2 border-purple-200 rounded-xl focus:border-purple-400 focus:outline-none">
                            <input type="text" id="newStudentName" placeholder="이름" 
                                   class="px-4 py-3 border-2 border-purple-200 rounded-xl focus:border-purple-400 focus:outline-none">
                            <button id="addStudentBtn" class="bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-xl font-semibold transition-colors">
                                ➕ 학생 추가
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 보상 관리 -->
                <div id="rewardsSection" class="space-y-8 hidden">
                    <!-- 보상 추가 -->
                    <div class="bg-white rounded-2xl cute-shadow p-6">
                        <h2 class="text-2xl font-bold text-purple-600 mb-4">🎁 보상 추가</h2>
                        <div class="grid md:grid-cols-3 gap-4 mb-4">
                            <input type="text" id="rewardName" placeholder="보상 이름" 
                                   class="px-4 py-3 border-2 border-purple-200 rounded-xl focus:border-purple-400 focus:outline-none">
                            <input type="number" id="rewardPoints" placeholder="필요 포인트" min="1"
                                   class="px-4 py-3 border-2 border-purple-200 rounded-xl focus:border-purple-400 focus:outline-none">
                            <button id="addRewardBtn" class="bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-semibold transition-colors">
                                ➕ 보상 추가
                            </button>
                        </div>
                    </div>

                    <!-- 보상 목록 -->
                    <div class="bg-white rounded-2xl cute-shadow p-6">
                        <h2 class="text-2xl font-bold text-purple-600 mb-4">🏆 보상 목록</h2>
                        <div id="rewardsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    </div>
                </div>

                <!-- 설정 -->
                <div id="settingsSection" class="space-y-8 hidden">
                    <!-- 학년도 및 수업 관리 -->
                    <div class="bg-white rounded-2xl cute-shadow p-6">
                        <h2 class="text-2xl font-bold text-purple-600 mb-4">📅 학년도 및 수업 관리</h2>
                        
                        <!-- 학년도 추가 -->
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-purple-600 mb-3">학년도 추가</h3>
                            <div class="flex gap-4">
                                <input type="number" id="newYear" placeholder="예: 2025" min="2020" max="2030"
                                       class="flex-1 px-4 py-3 border-2 border-purple-200 rounded-xl focus:border-purple-400 focus:outline-none">
                                <button id="addYearBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-xl font-semibold transition-colors">
                                    ➕ 추가
                                </button>
                            </div>
                        </div>

                        <!-- 수업 추가 -->
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-purple-600 mb-3">수업 추가</h3>
                            <div class="flex gap-4">
                                <input type="text" id="newSubject" placeholder="예: 수학, 과학"
                                       class="flex-1 px-4 py-3 border-2 border-purple-200 rounded-xl focus:border-purple-400 focus:outline-none">
                                <button id="addSubjectBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-xl font-semibold transition-colors">
                                    ➕ 추가
                                </button>
                            </div>
                        </div>

                        <!-- 현재 설정 -->
                        <div>
                            <h3 class="text-lg font-semibold text-purple-600 mb-3">현재 설정</h3>
                            <div class="bg-gray-50 rounded-xl p-4">
                                <div id="currentSettings" class="space-y-2 text-sm text-gray-700"></div>
                            </div>
                        </div>
                    </div>

                    <!-- 데이터 관리 -->
                    <div class="bg-white rounded-2xl cute-shadow p-6">
                        <h2 class="text-2xl font-bold text-purple-600 mb-4">💾 데이터 관리</h2>
                        <div class="grid md:grid-cols-2 gap-4">
                            <button id="exportDataBtn" class="bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-semibold transition-colors">
                                📤 데이터 내보내기
                            </button>
                            <button id="resetDataBtn" class="bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-semibold transition-colors">
                                🗑️ 데이터 초기화
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let currentUser = null;
        let currentYear = '';
        let currentSubject = '';
        let currentClass = '';
        let students = [];

        // 다양한 아바타 SVG
        const avatars = [
            `<svg width="60" height="60" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <circle cx="50" cy="50" r="45" fill="#FFB6C1"/>
                <circle cx="35" cy="35" r="4" fill="#FF1493"/>
                <circle cx="65" cy="35" r="4" fill="#FF1493"/>
                <path d="M 30 60 Q 50 75 70 60" stroke="#FF1493" stroke-width="3" fill="none"/>
                <circle cx="25" cy="25" r="6" fill="#FF69B4"/>
                <circle cx="75" cy="25" r="6" fill="#FF69B4"/>
            </svg>`,
            `<svg width="60" height="60" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <circle cx="50" cy="50" r="45" fill="#87CEEB"/>
                <circle cx="35" cy="38" r="3" fill="#4169E1"/>
                <circle cx="65" cy="38" r="3" fill="#4169E1"/>
                <path d="M 40 58 Q 50 65 60 58" stroke="#4169E1" stroke-width="2" fill="none"/>
                <rect x="35" y="20" width="30" height="8" rx="4" fill="#4169E1"/>
            </svg>`,
            `<svg width="60" height="60" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <circle cx="50" cy="50" r="45" fill="#98FB98"/>
                <circle cx="35" cy="40" r="4" fill="#228B22"/>
                <circle cx="65" cy="40" r="4" fill="#228B22"/>
                <ellipse cx="50" cy="60" rx="12" ry="8" fill="#228B22"/>
                <polygon points="40,15 50,5 60,15 50,25" fill="#32CD32"/>
            </svg>`,
            `<svg width="60" height="60" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <circle cx="50" cy="50" r="45" fill="#FFFF99"/>
                <circle cx="35" cy="38" r="3" fill="#FF8C00"/>
                <circle cx="65" cy="38" r="3" fill="#FF8C00"/>
                <path d="M 35 62 Q 50 72 65 62" stroke="#FF8C00" stroke-width="3" fill="none"/>
                <polygon points="45,20 50,10 55,20 50,30" fill="#FFD700"/>
            </svg>`,
            `<svg width="60" height="60" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <circle cx="50" cy="50" r="45" fill="#DDA0DD"/>
                <circle cx="35" cy="40" r="4" fill="#8A2BE2"/>
                <circle cx="65" cy="40" r="4" fill="#8A2BE2"/>
                <path d="M 40 60 Q 50 68 60 60" stroke="#8A2BE2" stroke-width="2" fill="none"/>
                <ellipse cx="35" cy="25" rx="8" ry="12" fill="#9370DB"/>
                <ellipse cx="65" cy="25" rx="8" ry="12" fill="#9370DB"/>
            </svg>`
        ];

        // Firebase 인증 상태 변화 감지
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                // 교사 인증 확인
                const isVerified = await checkTeacherVerification(user);
                if (isVerified) {
                    showMainApp();
                } else {
                    showVerificationScreen(user);
                }
            } else {
                currentUser = null;
                showLoginScreen();
            }
        });

        // 교사 인증 확인
        async function checkTeacherVerification(user) {
            try {
                const teacherRef = db.collection('teachers').doc(user.uid);
                const teacherDoc = await teacherRef.get();
                return teacherDoc.exists && teacherDoc.data().verified;
            } catch (error) {
                console.error('교사 인증 확인 오류:', error);
                return false;
            }
        }

        // 로그인 화면 표시
        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('verificationScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        // 인증 화면 표시
        function showVerificationScreen(user) {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('verificationScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('userEmail').textContent = user.email;
        }

        // 메인 앱 표시
        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('verificationScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userInfo').textContent = `👩‍🏫 ${currentUser.email}`;
            initializeApp();
        }

        // 구글 로그인
        document.getElementById('googleLoginBtn').addEventListener('click', async () => {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await auth.signInWithPopup(provider);
                console.log('로그인 성공:', result.user.email);
            } catch (error) {
                console.error('로그인 오류:', error);
                alert('로그인 실패: ' + error.message);
            }
        });

        // 교사 인증
        document.getElementById('verifyBtn').addEventListener('click', async () => {
            const code = document.getElementById('verificationCode').value;
            
            if (code === 'MINAH2025') {
                try {
                    // Firebase에 교사 정보 저장
                    const teacherRef = db.collection('teachers').doc(currentUser.uid);
                    await teacherRef.set({
                        email: currentUser.email,
                        verified: true,
                        verifiedAt: new Date().toISOString()
                    });
                    
                    alert('인증이 완료되었습니다!');
                    showMainApp();
                } catch (error) {
                    console.error('인증 저장 오류:', error);
                    alert('인증 저장 중 오류가 발생했습니다.');
                }
            } else {
                alert('인증 코드가 올바르지 않습니다.');
                document.getElementById('verificationCode').value = '';
            }
        });

        // 인증 취소
        document.getElementById('cancelBtn').addEventListener('click', async () => {
            await auth.signOut();
        });

        // 로그아웃
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            if (confirm('로그아웃 하시겠습니까?')) {
                try {
                    await auth.signOut();
                } catch (error) {
                    console.error('로그아웃 오류:', error);
                }
            }
        });

        // 앱 초기화
        function initializeApp() {
            setupMenuListeners();
            setupMobileMenu();
            setupSelectors();
            setupPointManagement();
            setupStudentManagement();
            setupRewardManagement();
            setupSettings();
            loadSettings();
        }

        // 메뉴 리스너 설정
        function setupMenuListeners() {
            document.getElementById('menuPoints').addEventListener('click', () => showSection('points'));
            document.getElementById('menuStudents').addEventListener('click', () => showSection('students'));
            document.getElementById('menuRewards').addEventListener('click', () => showSection('rewards'));
            document.getElementById('menuSettings').addEventListener('click', () => showSection('settings'));
        }

        // 섹션 표시
        function showSection(section) {
            // 모든 섹션 숨기기
            document.getElementById('pointsSection').classList.add('hidden');
            document.getElementById('studentsSection').classList.add('hidden');
            document.getElementById('rewardsSection').classList.add('hidden');
            document.getElementById('settingsSection').classList.add('hidden');
            
            // 메뉴 활성화 상태 제거
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // 선택된 섹션 표시
            document.getElementById(section + 'Section').classList.remove('hidden');
            document.getElementById('menu' + section.charAt(0).toUpperCase() + section.slice(1)).classList.add('active');
        }

        // 모바일 메뉴 설정
        function setupMobileMenu() {
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            mobileMenuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('-translate-x-full');
                sidebarOverlay.classList.toggle('hidden');
            });

            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
            });
        }

        // 선택자 설정
        function setupSelectors() {
            document.getElementById('yearSelect').addEventListener('change', (e) => {
                currentYear = e.target.value;
                loadStudents();
            });

            document.getElementById('subjectSelect').addEventListener('change', (e) => {
                currentSubject = e.target.value;
                loadStudents();
            });

            document.getElementById('classSelect').addEventListener('change', (e) => {
                currentClass = e.target.value;
                loadStudents();
            });
        }

        // 포인트 관리 설정
        function setupPointManagement() {
            document.getElementById('addPointBtn').addEventListener('click', addPoint);
        }

        // 학생 관리 설정
        function setupStudentManagement() {
            document.getElementById('uploadBtn').addEventListener('click', uploadExcel);
            document.getElementById('addStudentBtn').addEventListener('click', addStudent);
        }

        // 학생 데이터 로드
        async function loadStudents() {
            if (!currentYear || !currentSubject || !currentClass) return;

            const classKey = `${currentYear}-${currentSubject}-${currentClass}`;
            
            try {
                // Firebase에서 데이터 로드
                const classRef = db.collection('classes').doc(classKey);
                const docSnap = await classRef.get();
                
                if (docSnap.exists) {
                    students = docSnap.data().students || [];
                } else {
                    // 새 반 생성
                    students = [];
                    await classRef.set({
                        year: currentYear,
                        subject: currentSubject,
                        className: currentClass,
                        students: [],
                        createdAt: new Date().toISOString(),
                        createdBy: currentUser.uid
                    });
                }
                
                // 실시간 리스너 설정
                setupRealtimeListener(classKey);
                
            } catch (error) {
                console.error('Firebase 로드 오류:', error);
                // 로컬 저장소 백업
                const savedStudents = JSON.parse(localStorage.getItem(classKey) || '[]');
                students = savedStudents;
            }
            
            updateStudentSelect();
            displayStudents();
        }

        // 실시간 리스너 설정
        function setupRealtimeListener(classKey) {
            try {
                const classRef = db.collection('classes').doc(classKey);
                classRef.onSnapshot((doc) => {
                    if (doc.exists) {
                        students = doc.data().students || [];
                        updateStudentSelect();
                        displayStudents();
                    }
                });
            } catch (error) {
                console.error('실시간 리스너 오류:', error);
            }
        }

        // 학생 선택 드롭다운 업데이트
        function updateStudentSelect() {
            const select = document.getElementById('studentSelect');
            select.innerHTML = '<option value="">학생 선택</option>';
            
            students.forEach(student => {
                select.innerHTML += `<option value="${student.number}">${student.number}번 ${student.name}</option>`;
            });
        }

        // 학생 목록 표시
        function displayStudents() {
            const container = document.getElementById('studentsDisplay');
            container.innerHTML = '';

            students.forEach((student, index) => {
                const totalPoints = student.points ? student.points.reduce((sum, p) => sum + p.value, 0) : 0;
                const avatarIndex = index % avatars.length;
                
                const studentCard = document.createElement('div');
                studentCard.className = 'point-card bg-white rounded-2xl cute-shadow p-6 text-center hover:shadow-lg transition-all duration-300';
                studentCard.innerHTML = `
                    <div class="mb-4">${avatars[avatarIndex]}</div>
                    <h3 class="text-lg font-bold text-purple-600 mb-2">${student.number}번 ${student.name}</h3>
                    <div class="bg-gradient-to-r from-green-400 to-blue-500 text-white rounded-full px-4 py-2 font-bold text-xl mb-4">
                        ⭐ ${totalPoints}점
                    </div>
                    <div class="text-left">
                        <h4 class="text-sm font-bold text-purple-600 mb-2">최근 포인트</h4>
                        ${!student.points || student.points.length === 0 ? 
                            '<p class="text-gray-500 text-xs">포인트 없음</p>' :
                            `<div class="space-y-1 max-h-32 overflow-y-auto">
                                ${student.points.slice(-3).map(point => `
                                    <div class="bg-gray-50 rounded p-2 text-xs">
                                        <div class="flex justify-between">
                                            <span class="font-semibold">${point.category}</span>
                                            <span class="text-green-600">+${point.value}</span>
                                        </div>
                                        ${point.description ? `<p class="text-gray-600 mt-1">${point.description}</p>` : ''}
                                    </div>
                                `).join('')}
                            </div>`
                        }
                    </div>
                `;
                container.appendChild(studentCard);
            });
        }

        // 포인트 추가
        async function addPoint() {
            const studentNumber = parseInt(document.getElementById('studentSelect').value);
            const pointValue = parseInt(document.getElementById('pointValue').value);
            const category = document.getElementById('pointCategory').value;
            const description = document.getElementById('pointDescription').value;

            if (!studentNumber || !pointValue || !category) {
                alert('학생, 포인트, 카테고리를 모두 선택해주세요.');
                return;
            }

            const student = students.find(s => s.number === studentNumber);
            if (!student) {
                alert('학생을 찾을 수 없습니다.');
                return;
            }

            if (!student.points) {
                student.points = [];
            }

            student.points.push({
                value: pointValue,
                category: category,
                description: description,
                date: new Date().toISOString()
            });

            await saveStudents();
            displayStudents();
            
            // 폼 초기화
            document.getElementById('pointValue').value = '';
            document.getElementById('pointDescription').value = '';
            
            alert(`${student.name}에게 ${pointValue}점이 추가되었습니다!`);
        }

        // 학생 추가
        async function addStudent() {
            const number = parseInt(document.getElementById('newStudentNumber').value);
            const name = document.getElementById('newStudentName').value.trim();

            if (!number || !name) {
                alert('번호와 이름을 모두 입력해주세요.');
                return;
            }

            if (students.find(s => s.number === number)) {
                alert('이미 존재하는 번호입니다.');
                return;
            }

            students.push({
                number: number,
                name: name,
                points: []
            });

            students.sort((a, b) => a.number - b.number);
            
            await saveStudents();
            updateStudentSelect();
            displayStudents();
            
            // 폼 초기화
            document.getElementById('newStudentNumber').value = '';
            document.getElementById('newStudentName').value = '';
            
            alert(`${name} 학생이 추가되었습니다!`);
        }

        // 엑셀 업로드
        function uploadExcel() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];

            if (!file) {
                alert('파일을 선택해주세요.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});

                    const newStudents = [];
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row[0] && row[1]) {
                            newStudents.push({
                                number: parseInt(row[0]),
                                name: row[1].toString().trim(),
                                points: []
                            });
                        }
                    }

                    if (newStudents.length === 0) {
                        alert('유효한 학생 데이터가 없습니다.');
                        return;
                    }

                    students = newStudents.sort((a, b) => a.number - b.number);
                    saveStudents();
                    updateStudentSelect();
                    displayStudents();
                    
                    alert(`${newStudents.length}명의 학생이 업로드되었습니다!`);
                } catch (error) {
                    console.error('엑셀 파싱 오류:', error);
                    alert('엑셀 파일을 읽는 중 오류가 발생했습니다.');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // 학생 데이터 저장
        async function saveStudents() {
            if (!currentYear || !currentSubject || !currentClass) return;
            
            const classKey = `${currentYear}-${currentSubject}-${currentClass}`;
            
            try {
                // Firebase에 저장
                const classRef = db.collection('classes').doc(classKey);
                await classRef.update({
                    students: students,
                    lastUpdated: new Date().toISOString()
                });
            } catch (error) {
                console.error('Firebase 저장 오류:', error);
                // 로컬 저장소 백업
                localStorage.setItem(classKey, JSON.stringify(students));
            }
        }

        // 보상 관리 설정
        function setupRewardManagement() {
            document.getElementById('addRewardBtn').addEventListener('click', addReward);
        }

        // 설정 관리
        function setupSettings() {
            document.getElementById('addYearBtn').addEventListener('click', addYear);
            document.getElementById('addSubjectBtn').addEventListener('click', addSubject);
            document.getElementById('exportDataBtn').addEventListener('click', exportData);
            document.getElementById('resetDataBtn').addEventListener('click', resetData);
        }

        // 보상 추가
        function addReward() {
            const name = document.getElementById('rewardName').value.trim();
            const points = parseInt(document.getElementById('rewardPoints').value);

            if (!name || !points) {
                alert('보상 이름과 필요 포인트를 모두 입력해주세요.');
                return;
            }

            const rewards = JSON.parse(localStorage.getItem('rewards') || '[]');
            rewards.push({
                id: Date.now(),
                name: name,
                points: points,
                createdAt: new Date().toISOString()
            });

            localStorage.setItem('rewards', JSON.stringify(rewards));
            displayRewards();
            
            // 폼 초기화
            document.getElementById('rewardName').value = '';
            document.getElementById('rewardPoints').value = '';
            
            alert(`보상 "${name}"이 추가되었습니다!`);
        }

        // 보상 목록 표시
        function displayRewards() {
            const container = document.getElementById('rewardsList');
            const rewards = JSON.parse(localStorage.getItem('rewards') || '[]');
            
            container.innerHTML = '';
            
            rewards.forEach(reward => {
                const rewardCard = document.createElement('div');
                rewardCard.className = 'bg-gradient-to-r from-yellow-400 to-orange-500 text-white rounded-xl p-4 text-center';
                rewardCard.innerHTML = `
                    <div class="text-2xl mb-2">🏆</div>
                    <h3 class="font-bold text-lg mb-2">${reward.name}</h3>
                    <p class="text-sm opacity-90">${reward.points}점 필요</p>
                    <button onclick="deleteReward(${reward.id})" class="mt-2 bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs">
                        삭제
                    </button>
                `;
                container.appendChild(rewardCard);
            });
        }

        // 보상 삭제
        function deleteReward(id) {
            if (confirm('이 보상을 삭제하시겠습니까?')) {
                const rewards = JSON.parse(localStorage.getItem('rewards') || '[]');
                const filteredRewards = rewards.filter(r => r.id !== id);
                localStorage.setItem('rewards', JSON.stringify(filteredRewards));
                displayRewards();
            }
        }

        // 학년도 추가
        function addYear() {
            const year = document.getElementById('newYear').value;
            if (!year) {
                alert('학년도를 입력해주세요.');
                return;
            }

            const years = JSON.parse(localStorage.getItem('years') || '["2024", "2025"]');
            if (!years.includes(year)) {
                years.push(year);
                years.sort();
                localStorage.setItem('years', JSON.stringify(years));
                updateYearOptions();
                alert(`${year}년도가 추가되었습니다!`);
            } else {
                alert('이미 존재하는 학년도입니다.');
            }
            
            document.getElementById('newYear').value = '';
        }

        // 수업 추가
        function addSubject() {
            const subject = document.getElementById('newSubject').value.trim();
            if (!subject) {
                alert('수업명을 입력해주세요.');
                return;
            }

            const subjects = JSON.parse(localStorage.getItem('subjects') || '["영어"]');
            if (!subjects.includes(subject)) {
                subjects.push(subject);
                localStorage.setItem('subjects', JSON.stringify(subjects));
                updateSubjectOptions();
                alert(`"${subject}" 수업이 추가되었습니다!`);
            } else {
                alert('이미 존재하는 수업입니다.');
            }
            
            document.getElementById('newSubject').value = '';
        }

        // 설정 로드
        function loadSettings() {
            updateYearOptions();
            updateSubjectOptions();
            displayRewards();
            updateCurrentSettings();
        }

        // 학년도 옵션 업데이트
        function updateYearOptions() {
            const years = JSON.parse(localStorage.getItem('years') || '["2024", "2025"]');
            const select = document.getElementById('yearSelect');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">학년도 선택</option>';
            years.forEach(year => {
                select.innerHTML += `<option value="${year}">${year}</option>`;
            });
            
            if (currentValue) select.value = currentValue;
        }

        // 수업 옵션 업데이트
        function updateSubjectOptions() {
            const subjects = JSON.parse(localStorage.getItem('subjects') || '["영어"]');
            const select = document.getElementById('subjectSelect');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">수업 선택</option>';
            subjects.forEach(subject => {
                select.innerHTML += `<option value="${subject}">${subject}</option>`;
            });
            
            if (currentValue) select.value = currentValue;
        }

        // 현재 설정 표시
        function updateCurrentSettings() {
            const container = document.getElementById('currentSettings');
            const years = JSON.parse(localStorage.getItem('years') || '["2024", "2025"]');
            const subjects = JSON.parse(localStorage.getItem('subjects') || '["영어"]');
            
            container.innerHTML = `
                <div><strong>등록된 학년도:</strong> ${years.join(', ')}</div>
                <div><strong>등록된 수업:</strong> ${subjects.join(', ')}</div>
                <div><strong>현재 선택:</strong> ${currentYear || '없음'} - ${currentSubject || '없음'} - ${currentClass || '없음'}</div>
            `;
        }

        // 데이터 내보내기
        function exportData() {
            const allData = {
                students: students,
                rewards: JSON.parse(localStorage.getItem('rewards') || '[]'),
                years: JSON.parse(localStorage.getItem('years') || '["2024", "2025"]'),
                subjects: JSON.parse(localStorage.getItem('subjects') || '["영어"]'),
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `minah-class-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            alert('데이터가 내보내기되었습니다!');
        }

        // 데이터 초기화
        function resetData() {
            if (confirm('모든 데이터를 초기화하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                if (confirm('정말로 모든 학생 데이터와 설정을 삭제하시겠습니까?')) {
                    localStorage.clear();
                    students = [];
                    currentYear = '';
                    currentSubject = '';
                    currentClass = '';
                    
                    // 기본값 복원
                    localStorage.setItem('years', JSON.stringify(['2024', '2025']));
                    localStorage.setItem('subjects', JSON.stringify(['영어']));
                    
                    // UI 업데이트
                    document.getElementById('yearSelect').value = '';
                    document.getElementById('subjectSelect').value = '';
                    document.getElementById('classSelect').value = '';
                    
                    loadSettings();
                    displayStudents();
                    updateStudentSelect();
                    
                    alert('모든 데이터가 초기화되었습니다.');
                }
            }
        }

        // 전역 함수로 설정 (HTML에서 호출 가능)
        window.deleteReward = function(id) {
            if (confirm('이 보상을 삭제하시겠습니까?')) {
                const rewards = JSON.parse(localStorage.getItem('rewards') || '[]');
                const filteredRewards = rewards.filter(r => r.id !== id);
                localStorage.setItem('rewards', JSON.stringify(filteredRewards));
                displayRewards();
            }
        };

        // 페이지 로드시 초기화
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Minah Teacher\'s Class Points 시작!');
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'970de88d14a5ea28',t:'MTc1NTQ4MzM3OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
